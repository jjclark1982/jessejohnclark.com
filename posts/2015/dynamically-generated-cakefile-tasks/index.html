<!DOCTYPE html>
<html>
  <head>
    <title>Dynamically-generated Cakefile Tasks | Jesse Clark’s Blog</title>
    <link rel="stylesheet" href="/assets/normalize.css">
    <link rel="stylesheet" href="/assets/hljs-github.css">
    <link rel="stylesheet" href="/assets/style.css">
  </head>
  <body>
    <div class="container">
      <header>
        <h1><a href="/">Jesse Clark’s Blog</a></h1>
      </header>
      <article>
        <header>
          <h2><a href="/posts/2015/dynamically-generated-cakefile-tasks/">Dynamically-generated Cakefile Tasks</a></h2>
          <div class="author">by <span class="author-name">Jesse Clark</span></div>
          <div class="time">Published 
            <time class="published" datetime="2015-01-19T00:00:00.000Z">January 18, 2015</time>
          </div>
        </header><p><a href="http://coffeescript.org/documentation/docs/cake.html">Cake</a> is a task-runner for <a href="http://coffeescript.org/">CoffeeScript</a>.</p>
<p>It can be useful to invoke external scripts from <code>cake</code>, if they are written in another language or simply don&#39;t fit in the <code>Cakefile</code>. Suppose we have a <code>scripts</code> directory populated with various text-based executables, and we want to automatically define a <code>cake</code> task for each of those scripts, with an appropriate description, like so:</p>
<!-- more -->

<pre><code class="language-shell">$ ls scripts
build.py
clean.sh

$ cake
cake build                    # build the project
cake clean                    # remove built files

$ cake build --help
build.py: usage info...
</code></pre>
<p>We can do this in the <code>Cakefile</code> by reading each script and extracting its  first comment, then defining a task with that comment as its description:</p>
<pre><code class="language-coffeescript"># Define tasks for any scripts in the `scripts` directory
for basename in fs.readdirSync(&#39;./scripts&#39;) then do (basename)-&gt;
    return if basename[0] is &#39;.&#39;
    filename = &quot;./scripts/#{basename}&quot;
    contents = fs.readFileSync(filename, &#39;utf8&#39;)
    title = basename.replace(/\..*?$/, &#39;&#39;)
    # use the first block comment in the file as its description
    description = &#39;&#39;
    for line, i in contents.split(/[\r\n]+/)
        if line.match(/^#!/) then continue
        if line.match(/-\*- mode/) then continue
        if line.match(/^\s*(#|\/\/|$)/)
            description += line.replace(/^\s*(#|\/\/)\s*/, &#39; &#39;).trim()
            continue
        # stop reading when we encounter non-comment text
        break

    task(title, description, -&gt;
        # pass command-line arguments directly in to the script
        index = process.argv.indexOf(title)
        args = process.argv.slice(index+1)
        child_process.spawn(filename, args, {
            stdio: &#39;inherit&#39;
            env: env
        }).on(&#39;exit&#39;, (code, signal)-&gt;
            process.exit(code)
        )
        # prevent `cake` from invoking further tasks based on those arguments
        global.invoke = (-&gt;)
    )
</code></pre>

      </article>
      <nav>
        <div class="widget"><ul>
<li><a href="jobs/">R&eacute;sum&eacute;</a></li>
<li><a href="/posts">Blog</a> (<a href="/rss.xml">RSS Feed</a>)</li>
<li><a href="http://www.linkedin.com/profile/view?id=5026500">LinkedIn</a></li>
<li><a href="http://github.com/jjclark1982">GitHub</a></li>
<li><a href="http://stackoverflow.com/users/503963/phssthpok">Stack Overflow</a></li>
<li><a href="http://myhf.newsblur.com/">NewsBlur</a></li>
<li><a href="https://foursquare.com/myhf">Foursquare</a></li>
<li><a href="http://www.facebook.com/jesse.j.clark">Facebook</a></li>
<li><a href="http://www.google.com/profiles/jjclark1982">Google Plus</a></li>
<li><a href="http://old.thesixtyone.com/#/Phssthpok/">thesixtyone</a></li>
<li><a href="http://open.spotify.com/user/jjclark1982">Spotify</a></li>
<li><a href="https://twitter.com/spelunkyadvice">Bad Spelunky Advice</a></li>
</ul>
</div>
      </nav>
    </div>
  </body>
</html>